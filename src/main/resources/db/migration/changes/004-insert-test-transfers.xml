<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

  <changeSet id="003-insert-test-transfers" author="onenull">
    <comment>Insert test transfers for demonstration</comment>

    <!-- Test transfers between user's cards -->
    <sql> INSERT INTO transfers (owner_id, from_card_id, to_card_id, amount, created_at) SELECT
      u.id, (SELECT c1.id FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234'),
      (SELECT c2.id FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678'),
      250.00, NOW() - INTERVAL '7 days' FROM users u WHERE u.email = 'user@test.com' AND EXISTS
      (SELECT 1 FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234') AND EXISTS
      (SELECT 1 FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678') ON
      CONFLICT DO NOTHING; </sql>

    <sql> INSERT INTO transfers (owner_id, from_card_id, to_card_id, amount, created_at) SELECT
      u.id, (SELECT c2.id FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678'),
      (SELECT c1.id FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234'),
      100.00, NOW() - INTERVAL '3 days' FROM users u WHERE u.email = 'user@test.com' AND EXISTS
      (SELECT 1 FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234') AND EXISTS
      (SELECT 1 FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678') ON
      CONFLICT DO NOTHING; </sql>

    <sql> INSERT INTO transfers (owner_id, from_card_id, to_card_id, amount, created_at) SELECT
      u.id, (SELECT c1.id FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234'),
      (SELECT c2.id FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678'),
      50.50, NOW() - INTERVAL '1 day' FROM users u WHERE u.email = 'user@test.com' AND EXISTS
      (SELECT 1 FROM cards c1 WHERE c1.owner_id = u.id AND c1.card_number_last4 = '1234') AND EXISTS
      (SELECT 1 FROM cards c2 WHERE c2.owner_id = u.id AND c2.card_number_last4 = '5678') ON
      CONFLICT DO NOTHING; </sql>

    <rollback> DELETE FROM transfers WHERE owner_id IN ( SELECT id FROM users WHERE email IN
      ('user@test.com', 'admin@test.com') ); </rollback>
  </changeSet>

</databaseChangeLog>